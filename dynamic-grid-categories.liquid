{% assign cat_links = category_links | split: ',' %}
{% assign cat_names = category_names_EN | split: ',' %}
{% assign base_url  = 'https://www.altitude-sports.com/collections/' %}

{% if is_tlh == true %}
    {% assign base_url  = 'https://www.thelasthunt.com/collections/' %}
{% endif %}

{% if customer.language == "fr" or tags contains "lang_fr" and customer.language != "en" %}
    {% assign cat_names = category_names_FR | split: ',' %}
    {% assign base_url  = 'https://fr.altitude-sports.com/' %}
    {% if is_tlh == true %}
        {% assign base_url  = 'https://www.ladernierechasse.com/collections/' %}
    {% endif %}
{% endif %}

{% assign nbCol = column | plus: 0 %}
{% assign product_count = 0 %}
{% assign title_length  = 0 %} 
{% assign max_char = 80 | divided_by: nbCol | round  %}
{% assign nb_line = 0 %}
{% assign img_height = 600 | divided_by: nbCol %}
{% if product_img_height and product_img_height != "" %}
    {% assign img_height = product_img_height %}
{% endif %}

{% for title in cat_names %}
    {% if title.size > title_length %}
        {% assign title_length = title.size %}      
    {% endif %}
{% endfor %}

{% assign nb_line = title_length | divided_by: max_char | plus: 2 %}
{% assign title_height = nb_line | times: 20 %}

<!--[if mso]>
  <style type="text/css">
    .product-border {
        
      border: 0 !important;
      padding: 0 !important
    }
    .resize-height-image img {
        display: inline;
    }
  </style>
<![endif]-->

{% for product in products %}
    {% assign i = forloop.index0 | plus: 0 %}
    {% assign product_count = product_count | plus: 1 %}
    {% assign outlook_row = product_count | modulo: nbCol %}
    {% assign outlook_width = 600 | divided_by: nbCol | times: 0.65| round %}
    {% assign td_width = 100 | divided_b</div>
                        y: nbCol | round %}
    {% assign row_last = product_count | modulo: nbCol %}
    {% if row_last == 0 %}
        {% assign td_width = td_width | minus: 1 %}
    {% endif %}
    
    {% assign mobile_min_width = "150px" %}
    {% if mobile_2_columns == false %}
        {% assign mobile_min_width = "190px" %}
        <!-- iPhone style  -->
        <style>
        @media screen and (max-width:425px) {
            .product {
                width: 100% !important;
            }
            .product img {
                max-width: 200px;
            }
            .product-image {
                height:auto !important;
            }
        }
        </style>
    {% else %}
        <!-- iPhone style  -->
        <style>
        @media screen and (max-width:425px) {
            .product {
                width: 45% !important;
            }
            .product-border,
            .product-image {
                height: 150px;
            }
            .product-image img {
                max-height: 150px !important;
            }
            .resize-height-image {
                height: 105px;
            }
            .resize-height-image img {
                max-height: 105px !important;
            }
        }
        </style>
    {% endif %}
    
    {% if forloop.index == 1 %}
        <table class="product-container" width="100%" style="width: 100%; min-width: 100%;" align="center">
            <tr>
                <td class="product" style="text-align: center; padding-top: 20px; vertical-align: bottom" valign="bottom">
    {% else %}
        <!--[if mso]><td class="product" style="text-align: center; padding-top: 20px; vertical-align: bottom" valign="bottom"><![endif]-->
    {% endif %}

    <div class="product" style="width: {{ td_width }}%; display: inline-block; min-width: {{ mobile_min_width }};">
        <table width="100%" style="width: 100%; min-width: 100%;">
            <tr>     
                <!-- Product image -->
            {% if show_border == true %}
                <td class="product-image-border" style="text-align:center; height: {{ img_height }}px; padding: 0 15px;">
                    <table width="100%" style="width: 100%; min-width: 100%;">
                        <tr>
                            <!--[if mso]><td class="product-border" style="height:{{ img_height }}px; text-align: center"><![endif]-->
                            <!--[if !mso]>-->
                            <td class="product-border" style="border: 1px solid; height:{{ img_height | minus: 40 }}px; padding: 18px; text-align: center">
                            <!--<![endif]-->
                                <a href="{{  cat_links[i] | prepend: base_url  }}">
                                    <div class="resize-height-image" height="{{ img_height | minus: 45 }}px" width="{{ outlook_width }}px" style="background-image:url({{ product.image_url }}); background-size: contain; background-position: center; background-repeat: no-repeat; text-align:center; height: {{ img_height | minus: 45 }}px;">
                                        <img src="{{ product.image_url }}" alt="{{ cat_names[i] }}" style="display: none;width:auto; height: auto; max-width: 85%; max-height: {{ img_height | minus: 45 }}px;" width="{{ outlook_width }}" />
                                    </div>
                                </a>
                            </td>
                        </tr>
                    </table>
                </td>
            {% else %}
                <td class="product-image" style="text-align:center; height: {{ img_height }}px; padding: 0 15px; vertical-align: bottom; <!--[if mso]>" height="{{ img_height | plus: 35 }}<![endif]-->">
                    <a href="{{  cat_links[i] | prepend: base_url  }}">
                        <img src="{{ product.image_url }}" alt="{{ cat_names[i] }}" style="width:auto; height: auto; max-width: 85%; max-height: {{ img_height | minus: 25 }}px;" width="{{ outlook_width }}" />
                    </a>
                </td>
            {% endif %}
            </tr>

            {% if show_vendor == true or show_product_name == true or show_price == true or show_qty == true %}
                <tr>
                    <!-- Product infos -->
                    <td style="padding: 15px 5px 0; font-family: sans-serif; font-size: 15px;font-weight: bold; height: {{ title_height }}px; line-height: 18px; text-align: center; vertical-align:top;">
                        <a href="{{ cat_links[i] | prepend: base_url }}" style="color:#000;text-decoration:none;">{{ cat_names[i] }} â€º</a>
                    </td>
                </tr>
            {% endif %}
        </table>
    </div>
    {% if forloop.last == true %}
                </td>
            </tr>
        </table>
    {% else %}
        <!--[if mso]></td><![endif]-->
        {% if outlook_row == 0  %}
            <!--[if mso]></tr><tr><![endif]-->
        {% endif %}
    {% endif %}
{% endfor %}